trigger:
  branches:
    include:
      - main
  paths:
    include:
      - backend/**
      - azure-pipelines-backend.yml

pr:
  branches:
    include:
      - main
  paths:
    include:
      - backend/**

pool:
  vmImage: ubuntu-latest

variables:
  pythonVersion: '3.11'

  # App Service
  appType: 'webAppLinux'
  runtimeStack: 'PYTHON|3.11'
  websitesPort: '8000'
  startupCommand: 'gunicorn -k uvicorn.workers.UvicornWorker app:app --bind=0.0.0.0:$(websitesPort)'

  # Artifacts
  artifactName: 'backendpython'
  packageFileName: 'app.zip'

  # Deployment
  azureServiceConnection: 'LabsConn'
  webAppName: 'backendpython'
  environmentName: 'prod'

stages:
  - stage: BuildBackend
    displayName: 'Build Backend'
    jobs:
      - job: Build
        displayName: 'Build & Test Backend'
        steps:
          - checkout: self
            fetchDepth: 1

          - task: UsePythonVersion@0
            displayName: 'Use Python $(pythonVersion)'
            inputs:
              versionSpec: '$(pythonVersion)'
              addToPath: true

          - task: Cache@2
            displayName: 'Cache pip'
            inputs:
              key: 'pip | "$(Agent.OS)" | backend/requirements.txt'
              restoreKeys: |
                pip | "$(Agent.OS)"
              path: $(Pipeline.Workspace)/.pip

          - script: |
              python -m pip install --upgrade pip
              python -m pip install --cache-dir $(Pipeline.Workspace)/.pip -r backend/requirements.txt
            displayName: 'Install dependencies'

          - script: |
              cd backend
              python -m compileall -q .
              python -c "import importlib; importlib.import_module('app')"
            displayName: 'Validate syntax & import app'

          - task: CopyFiles@2
            displayName: 'Stage backend sources'
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/backend'
              Contents: |
                **/*
                !tests/**
                !**/__pycache__/**
                !**/*.pyc
                !**/.git/**
                !*.db
                !pytest.ini
              TargetFolder: '$(Build.ArtifactStagingDirectory)/src'

          - task: ArchiveFiles@2
            displayName: 'Create deployment package'
            inputs:
              rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/src'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(packageFileName)'
              replaceExistingArchive: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish backend artifact'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/$(packageFileName)'
              ArtifactName: '$(artifactName)'

  - stage: DeployBackend
    displayName: 'Deploy Backend'
    dependsOn: BuildBackend
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), ne(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - deployment: DeployToAppService
        displayName: 'Deploy to Azure App Service'
        environment: '$(environmentName)'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  displayName: 'Download backend artifact'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: '$(artifactName)'
                    downloadPath: '$(Pipeline.Workspace)/artifacts'

                - task: AzureAppServiceSettings@1
                  displayName: 'Configure App Service settings'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appName: '$(webAppName)'
                    appSettings: |
                      [
                        {
                          "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                          "value": "true",
                          "slotSetting": false
                        },
                        {
                          "name": "ENABLE_ORYX_BUILD",
                          "value": "true",
                          "slotSetting": false
                        },
                        {
                          "name": "WEBSITES_PORT",
                          "value": "$(websitesPort)",
                          "slotSetting": false
                        }
                      ]

                - task: AzureWebApp@1
                  displayName: 'Deploy to App Service'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appType: '$(appType)'
                    appName: '$(webAppName)'
                    runtimeStack: '$(runtimeStack)'
                    startupCommand: '$(startupCommand)'
                    package: '$(Pipeline.Workspace)/artifacts/$(artifactName)/$(packageFileName)'
