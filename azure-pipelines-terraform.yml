trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  pythonVersion: '3.11'
  nodeVersion: '18.x'

  # App / Infra
  location: 'westeurope'
  resourceGroupName: 'rg-backendpython-prod'
  appServicePlanName: 'asp-backendpython-prod'
  appServicePlanSkuName: 'B1'
  webAppName: 'backendpython'
  websitesPort: '8000'
  startupCommand: 'gunicorn -k uvicorn.workers.UvicornWorker app:app --bind=0.0.0.0:$(websitesPort)'
  enableAppInsights: 'true'

  # Terraform state (NECESITA ser único globalmente)
  tfStateResourceGroupName: 'rg-tfstate-backendpython'
  tfStateLocation: 'westeurope'
  tfStateStorageAccountName: 'tfstatebackendpython'  # <= cambia esto a algo único (lowercase, 3-24)
  tfStateContainerName: 'tfstate'
  tfStateKey: 'backendpython.prod.tfstate'

  # Artifacts
  artifactName: 'backendpython'
  packageFileName: 'app.zip'
  reactArtifactName: 'frontend-react'
  angularArtifactName: 'frontend-angular'

  # Deployment
  azureServiceConnection: 'LabsConn'
  environmentName: 'prod'

stages:
  - stage: Terraform
    displayName: 'Infrastructure (Terraform)'
    dependsOn: []
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), ne(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - job: ApplyTerraform
        displayName: 'Terraform init/plan/apply'
        steps:
          - checkout: self
            fetchDepth: 1

          - task: AzureCLI@2
            displayName: 'Install Terraform'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euo pipefail
                if command -v terraform >/dev/null 2>&1; then
                  terraform -version
                  exit 0
                fi

                sudo apt-get update -y
                sudo apt-get install -y gnupg software-properties-common curl
                curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg >/dev/null
                echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
                sudo apt-get update -y
                sudo apt-get install -y terraform
                terraform -version

          - task: AzureCLI@2
            displayName: 'Ensure Terraform remote state (Storage Account)'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euo pipefail

                echo "Ensuring tfstate RG: $(tfStateResourceGroupName)"
                az group create --name "$(tfStateResourceGroupName)" --location "$(tfStateLocation)" >/dev/null

                echo "Ensuring tfstate Storage Account: $(tfStateStorageAccountName)"
                if ! az storage account show --name "$(tfStateStorageAccountName)" --resource-group "$(tfStateResourceGroupName)" >/dev/null 2>&1; then
                  az storage account create \
                    --name "$(tfStateStorageAccountName)" \
                    --resource-group "$(tfStateResourceGroupName)" \
                    --location "$(tfStateLocation)" \
                    --sku Standard_LRS \
                    --kind StorageV2 \
                    --allow-blob-public-access false \
                    --min-tls-version TLS1_2 \
                    >/dev/null
                fi

                echo "Ensuring tfstate container: $(tfStateContainerName)"
                TFSTATE_KEY=$(az storage account keys list --account-name "$(tfStateStorageAccountName)" --resource-group "$(tfStateResourceGroupName)" --query "[0].value" -o tsv)
                az storage container create \
                  --name "$(tfStateContainerName)" \
                  --account-name "$(tfStateStorageAccountName)" \
                  --account-key "$TFSTATE_KEY" \
                  >/dev/null

          - task: AzureCLI@2
            displayName: 'Terraform apply'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euo pipefail
                cd infra/terraform

                terraform init \
                  -backend-config="resource_group_name=$(tfStateResourceGroupName)" \
                  -backend-config="storage_account_name=$(tfStateStorageAccountName)" \
                  -backend-config="container_name=$(tfStateContainerName)" \
                  -backend-config="key=$(tfStateKey)"

                terraform plan \
                  -out tfplan \
                  -var "location=$(location)" \
                  -var "resource_group_name=$(resourceGroupName)" \
                  -var "app_service_plan_name=$(appServicePlanName)" \
                  -var "app_service_plan_sku_name=$(appServicePlanSkuName)" \
                  -var "web_app_name=$(webAppName)" \
                  -var "python_version=$(pythonVersion)" \
                  -var "websites_port=$(websitesPort)" \
                  -var "startup_command=$(startupCommand)" \
                  -var "enable_app_insights=$(enableAppInsights)"

                terraform apply -auto-approve tfplan

  - stage: Build
    displayName: 'Build'
    dependsOn: Terraform
    jobs:
      - job: Build
        displayName: 'Build & Package'
        steps:
          - checkout: self
            fetchDepth: 1

          - task: NodeTool@0
            displayName: 'Use Node.js $(nodeVersion)'
            inputs:
              versionSpec: '$(nodeVersion)'

          - task: UsePythonVersion@0
            displayName: 'Use Python $(pythonVersion)'
            inputs:
              versionSpec: '$(pythonVersion)'
              addToPath: true

          - task: Cache@2
            displayName: 'Cache pip'
            inputs:
              key: 'pip | "$(Agent.OS)" | requirements.txt'
              restoreKeys: |
                pip | "$(Agent.OS)"
              path: $(Pipeline.Workspace)/.pip

          - script: |
              python -m pip install --upgrade pip
              python -m pip install --cache-dir $(Pipeline.Workspace)/.pip -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              python -m compileall -q .
              python -c "import importlib; importlib.import_module('app')"
            displayName: 'Validate syntax & import app'

          - script: |
              set -e
              cd frontend/react-products-console
              npm install
              npm run build
            displayName: 'Build React frontend'

          - script: |
              set -e
              cd frontend/angular-products-console
              npm install
              npm run build
            displayName: 'Build Angular frontend'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish React artifact'
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/frontend/react-products-console/dist'
              ArtifactName: '$(reactArtifactName)'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Angular artifact'
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/frontend/angular-products-console/dist/angular-products-console'
              ArtifactName: '$(angularArtifactName)'

          - task: CopyFiles@2
            displayName: 'Stage sources'
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)'
              Contents: |
                **/*
                !frontend/**
                !**/__pycache__/**
                !**/*.pyc
                !**/.git/**
              TargetFolder: '$(Build.ArtifactStagingDirectory)/src'

          - task: ArchiveFiles@2
            displayName: 'Create deployment package'
            inputs:
              rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/src'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(packageFileName)'
              replaceExistingArchive: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/$(packageFileName)'
              ArtifactName: '$(artifactName)'

  - stage: Deploy
    displayName: 'Deploy App'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), ne(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - deployment: DeployWebApp
        displayName: 'Deploy to Azure App Service'
        environment: '$(environmentName)'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  displayName: 'Download build artifact $(artifactName)'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: '$(artifactName)'
                    downloadPath: '$(Pipeline.Workspace)/artifacts'

                - task: AzureAppServiceSettings@1
                  displayName: 'Configure App Service settings'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appName: '$(webAppName)'
                    appSettings: |
                      [
                        {
                          "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                          "value": "true",
                          "slotSetting": false
                        },
                        {
                          "name": "ENABLE_ORYX_BUILD",
                          "value": "true",
                          "slotSetting": false
                        },
                        {
                          "name": "WEBSITES_PORT",
                          "value": "$(websitesPort)",
                          "slotSetting": false
                        }
                      ]

                - task: AzureWebApp@1
                  displayName: 'Zip Deploy to Web App'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appType: 'webAppLinux'
                    appName: '$(webAppName)'
                    runtimeStack: 'PYTHON|$(pythonVersion)'
                    startupCommand: '$(startupCommand)'
                    package: '$(Pipeline.Workspace)/artifacts/$(artifactName)/$(packageFileName)'
