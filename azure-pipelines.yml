trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  pythonVersion: '3.11'
  nodeVersion: '18.x'

  # App Service
  # - webAppLinux (recomendado para Python) o webApp (Windows)
  appType: 'webAppLinux'
  # Runtime stack para Linux App Service (ajusta si cambias pythonVersion)
  runtimeStack: 'PYTHON|3.11'
  # Puerto que expondrá el contenedor en App Service Linux
  websitesPort: '8000'
  # Startup command (solo aplica a Linux). Ajusta según tu framework.
  # FastAPI: gunicorn -k uvicorn.workers.UvicornWorker app:app --bind=0.0.0.0:8000
  startupCommand: 'gunicorn -k uvicorn.workers.UvicornWorker app:app --bind=0.0.0.0:$(websitesPort)'

  # Artifacts
  artifactName: 'backendpython'
  packageFileName: 'app.zip'
  angularCrudArtifactName: 'frontend-angular-crud'

  # Deployment (configúralo en Variables del pipeline o Variable Group)
  azureServiceConnection: 'LabsConn'
  webAppName: 'backendpython'
  staticWebAppName: 'pythonSWA'
  environmentName: 'prod'

stages:
  - stage: Build
    displayName: 'Build'
    jobs:
      - job: Build
        displayName: 'Build & Package'
        steps:
          - checkout: self
            fetchDepth: 1

          - task: NodeTool@0
            displayName: 'Use Node.js $(nodeVersion)'
            inputs:
              versionSpec: '$(nodeVersion)'

          - task: UsePythonVersion@0
            displayName: 'Use Python $(pythonVersion)'
            inputs:
              versionSpec: '$(pythonVersion)'
              addToPath: true

          - task: Cache@2
            displayName: 'Cache pip'
            inputs:
              key: 'pip | "$(Agent.OS)" | requirements.txt'
              restoreKeys: |
                pip | "$(Agent.OS)"
              path: $(Pipeline.Workspace)/.pip

          - script: |
              python -m pip install --upgrade pip
              python -m pip install --cache-dir $(Pipeline.Workspace)/.pip -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              python -m compileall -q .
              python -c "import importlib; importlib.import_module('app')"
            displayName: 'Validate syntax & import app'

          # Backend Testing
          - script: |
              python -m pytest -v --tb=short --junitxml=test-results.xml
            displayName: 'Run backend tests (pytest)'
            continueOnError: false

          - task: PublishTestResults@2
            displayName: 'Publish backend test results'
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results.xml'
              testRunTitle: 'Backend API Tests'
              failTaskOnFailedTests: true

          # Angular CRUD Build
          - task: Cache@2
            displayName: 'Cache Angular CRUD node_modules'
            inputs:
              key: 'npm | "$(Agent.OS)" | frontend/angular-products-crud/package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: frontend/angular-products-crud/node_modules

          - script: |
              set -e
              cd frontend/angular-products-crud
              npm install
              npm run build
            displayName: 'Build Angular CRUD frontend'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Angular CRUD artifact'
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/frontend/angular-products-crud/dist/angular-products-crud'
              ArtifactName: '$(angularCrudArtifactName)'

          # Empaquetado para Zip Deploy (App Service)
          - task: CopyFiles@2
            displayName: 'Stage sources'
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)'
              Contents: |
                **/*
                !frontend/**
                !tests/**
                !**/__pycache__/**
                !**/*.pyc
                !**/.git/**
                !.venv/**
                !*.db
                !pytest.ini
              TargetFolder: '$(Build.ArtifactStagingDirectory)/src'

          - task: ArchiveFiles@2
            displayName: 'Create deployment package'
            inputs:
              rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/src'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(packageFileName)'
              replaceExistingArchive: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/$(packageFileName)'
              ArtifactName: '$(artifactName)'
  - stage: DeployBackend
    displayName: 'Deploy Backend'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), ne(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - deployment: DeployBackendToAppService
        displayName: 'Deploy Backend to Azure App Service'
        environment: '$(environmentName)'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  displayName: 'Download build artifact $(artifactName)'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: '$(artifactName)'
                    downloadPath: '$(Pipeline.Workspace)/artifacts'

                # App Settings recomendados para Zip Deploy + build en App Service (Oryx)
                - task: AzureAppServiceSettings@1
                  displayName: 'Configure App Service settings'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appName: '$(webAppName)'
                    appSettings: |
                      [
                        {
                          "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                          "value": "true",
                          "slotSetting": false
                        },
                        {
                          "name": "ENABLE_ORYX_BUILD",
                          "value": "true",
                          "slotSetting": false
                        },
                        {
                          "name": "WEBSITES_PORT",
                          "value": "$(websitesPort)",
                          "slotSetting": false
                        }
                      ]

                - task: AzureWebApp@1
                  displayName: 'Zip Deploy to Web App'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appType: '$(appType)'
                    appName: '$(webAppName)'
                    runtimeStack: '$(runtimeStack)'
                    startupCommand: '$(startupCommand)'
                    package: '$(Pipeline.Workspace)/artifacts/$(artifactName)/$(packageFileName)'

  - stage: DeployFrontend
    displayName: 'Deploy Frontend'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), ne(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - deployment: DeployAngularCrudToSWA
        displayName: 'Deploy Angular CRUD to Static Web App'
        environment: '$(environmentName)'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  displayName: 'Download Angular CRUD artifact'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: '$(angularCrudArtifactName)'
                    downloadPath: '$(Pipeline.Workspace)/artifacts'

                - task: AzureStaticWebApp@0
                  displayName: 'Deploy to Static Web App'
                  inputs:
                    app_location: '$(Pipeline.Workspace)/artifacts/$(angularCrudArtifactName)'
                    skip_app_build: true
                    azure_static_web_apps_api_token: '$(AZURE_STATIC_WEB_APPS_API_TOKEN)'
