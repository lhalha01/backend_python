trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  pythonVersion: '3.11'
  nodeVersion: '18.x'

  # App Service
  # - webAppLinux (recomendado para Python) o webApp (Windows)
  appType: 'webAppLinux'
  # Runtime stack para Linux App Service (ajusta si cambias pythonVersion)
  runtimeStack: 'PYTHON|3.11'
  # Puerto que expondrá el contenedor en App Service Linux
  websitesPort: '8000'
  # Startup command (solo aplica a Linux). Ajusta según tu framework.
  # FastAPI: gunicorn -k uvicorn.workers.UvicornWorker app:app --bind=0.0.0.0:8000
  startupCommand: 'gunicorn -k uvicorn.workers.UvicornWorker app:app --bind=0.0.0.0:$(websitesPort)'

  # Artifacts
  artifactName: 'backendpython'
  packageFileName: 'app.zip'
  reactArtifactName: 'frontend-react'
  angularArtifactName: 'frontend-angular'

  # Deployment (configúralo en Variables del pipeline o Variable Group)
  azureServiceConnection: 'LabsConn'
  webAppName: 'backendpython'
  environmentName: 'prod'

stages:
  - stage: Build
    displayName: 'Build'
    jobs:
      - job: Build
        displayName: 'Build & Package'
        steps:
          - checkout: self
            fetchDepth: 1

          - task: NodeTool@0
            displayName: 'Use Node.js $(nodeVersion)'
            inputs:
              versionSpec: '$(nodeVersion)'

          - task: UsePythonVersion@0
            displayName: 'Use Python $(pythonVersion)'
            inputs:
              versionSpec: '$(pythonVersion)'
              addToPath: true

          - task: Cache@2
            displayName: 'Cache pip'
            inputs:
              key: 'pip | "$(Agent.OS)" | requirements.txt'
              restoreKeys: |
                pip | "$(Agent.OS)"
              path: $(Pipeline.Workspace)/.pip

          - script: |
              python -m pip install --upgrade pip
              python -m pip install --cache-dir $(Pipeline.Workspace)/.pip -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              python -m compileall -q .
              python -c "import importlib; importlib.import_module('app')"
            displayName: 'Validate syntax & import app'

          - script: |
              set -e
              cd frontend/react-products-console
              npm install
              npm run build
            displayName: 'Build React frontend'

          - script: |
              set -e
              cd frontend/angular-products-console
              npm install
              npm run build
            displayName: 'Build Angular frontend'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish React artifact'
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/frontend/react-products-console/dist'
              ArtifactName: '$(reactArtifactName)'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Angular artifact'
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/frontend/angular-products-console/dist/angular-products-console'
              ArtifactName: '$(angularArtifactName)'

          # Empaquetado para Zip Deploy (App Service)
          - task: CopyFiles@2
            displayName: 'Stage sources'
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)'
              Contents: |
                **/*
                !frontend/**
                !**/__pycache__/**
                !**/*.pyc
                !**/.git/**
              TargetFolder: '$(Build.ArtifactStagingDirectory)/src'

          - task: ArchiveFiles@2
            displayName: 'Create deployment package'
            inputs:
              rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/src'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(packageFileName)'
              replaceExistingArchive: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/$(packageFileName)'
              ArtifactName: '$(artifactName)'
  - stage: Deploy
    displayName: 'Deploy'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), ne(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - deployment: DeployWebApp
        displayName: 'Deploy to Azure App Service'
        environment: '$(environmentName)'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  displayName: 'Download build artifact $(artifactName)'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: '$(artifactName)'
                    downloadPath: '$(Pipeline.Workspace)/artifacts'

                # App Settings recomendados para Zip Deploy + build en App Service (Oryx)
                - task: AzureAppServiceSettings@1
                  displayName: 'Configure App Service settings'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appName: '$(webAppName)'
                    appSettings: |
                      [
                        {
                          "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                          "value": "true",
                          "slotSetting": false
                        },
                        {
                          "name": "ENABLE_ORYX_BUILD",
                          "value": "true",
                          "slotSetting": false
                        },
                        {
                          "name": "WEBSITES_PORT",
                          "value": "$(websitesPort)",
                          "slotSetting": false
                        }
                      ]

                - task: AzureWebApp@1
                  displayName: 'Zip Deploy to Web App'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appType: '$(appType)'
                    appName: '$(webAppName)'
                    runtimeStack: '$(runtimeStack)'
                    startupCommand: '$(startupCommand)'
                    package: '$(Pipeline.Workspace)/artifacts/$(artifactName)/$(packageFileName)'
