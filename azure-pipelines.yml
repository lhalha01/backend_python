trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  pythonVersion: '3.11'
  artifactName: 'backend-python'

steps:
  - checkout: self
    fetchDepth: 1

  - task: UsePythonVersion@0
    displayName: 'Use Python $(pythonVersion)'
    inputs:
      versionSpec: '$(pythonVersion)'
      addToPath: true

  - task: Cache@2
    displayName: 'Cache pip'
    inputs:
      key: 'pip | "$(Agent.OS)" | requirements.txt'
      restoreKeys: |
        pip | "$(Agent.OS)"
      path: $(Pipeline.Workspace)/.pip

  - script: |
      python -m pip install --upgrade pip
      python -m pip install --cache-dir $(Pipeline.Workspace)/.pip -r requirements.txt
    displayName: 'Install dependencies'

  - script: |
      python -m compileall -q app.py
      python -c "import app; print(app.app.title)"
    displayName: 'Validate syntax & imports'

  # Si más adelante añades tests con pytest, descomenta esto:
  # - script: |
  #     python -m pip install --cache-dir $(Pipeline.Workspace)/.pip pytest
  #     pytest -q
  #   displayName: 'Run tests'

  - task: CopyFiles@2
    displayName: 'Stage sources'
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)'
      Contents: |
        **/*
        !**/__pycache__/**
        !**/*.pyc
        !**/.git/**
      TargetFolder: '$(Build.ArtifactStagingDirectory)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish artifact'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: '$(artifactName)'